<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCAPC - HTTP Replayer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .container { max-width: 100%; padding: 10px; }

        h1 {
            text-align: center;
            padding: 15px;
            background: #16213e;
            color: #0f0;
            font-size: 1.5em;
            border-bottom: 2px solid #0f3460;
        }

        .panel {
            background: #16213e;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .panel-header {
            background: #0f3460;
            padding: 12px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-body {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .btn {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .btn:hover { background: #0c0; }
        .btn:disabled { background: #444; color: #888; cursor: not-allowed; }
        .btn-secondary { background: #0f3460; color: #fff; }
        .btn-execute { background: #e94560; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .btn-danger { background: #c0392b; }

        .list-item {
            padding: 12px;
            border-bottom: 1px solid #0f3460;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:hover { background: #1f4068; }
        .list-item:last-child { border-bottom: none; }

        .folder-icon { color: #ffd700; margin-right: 8px; }

        .badge {
            background: #e94560;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }

        .badge-auth { background: #f39c12; }
        .badge-cookie { background: #3498db; }
        .badge-count { background: #0f3460; }

        .method {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 8px;
            display: inline-block;
        }

        .method-GET { background: #27ae60; }
        .method-POST { background: #e94560; }
        .method-PUT { background: #f39c12; }
        .method-DELETE { background: #c0392b; }
        .method-PATCH { background: #9b59b6; }

        .uri {
            font-family: monospace;
            font-size: 12px;
            color: #aaa;
            word-break: break-all;
        }

        .path-display {
            padding: 10px;
            background: #0f3460;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .status { text-align: center; padding: 20px; color: #888; }

        .loader {
            border: 3px solid #0f3460;
            border-top: 3px solid #0f0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .payload-box {
            background: #0a0a1a;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid #0f3460;
        }

        .payload-header {
            background: #0f3460;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payload-header.request { border-left: 4px solid #3498db; }
        .payload-header.response { border-left: 4px solid #27ae60; }
        .payload-header.response.error { border-left: 4px solid #e94560; }
        .payload-header.response.waiting { border-left: 4px solid #666; opacity: 0.7; }

        .payload-section {
            padding: 12px;
            border-bottom: 1px solid #1a1a2e;
        }

        .payload-section:last-child { border-bottom: none; }

        .payload-section-title {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payload-content {
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 250px;
            overflow: auto;
            color: #ccc;
        }

        .edit-input {
            width: 100%;
            padding: 10px;
            background: #16213e;
            border: 1px solid #0f3460;
            color: #fff;
            font-family: monospace;
            font-size: 13px;
            border-radius: 4px;
        }

        .edit-input:focus { outline: none; border-color: #0f0; }

        .edit-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            background: #16213e;
            border: 1px solid #0f3460;
            color: #fff;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            resize: vertical;
        }

        .edit-textarea:focus { outline: none; border-color: #0f0; }

        .edit-select {
            background: #16213e;
            color: #0f0;
            border: 1px solid #0f3460;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
        }

        .header-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .header-row input { flex: 1; }
        .header-row .header-key { flex: 0.35; }
        .header-row .header-value { flex: 0.55; }
        .header-row .btn { flex: 0.1; padding: 8px; }

        .actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .actions .btn { flex: 1; min-width: 100px; }

        .hidden { display: none !important; }

        .back-btn {
            background: none;
            border: none;
            color: #0f0;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 10px;
        }

        .stat {
            background: #0f3460;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
        }

        .stat-value { color: #0f0; font-weight: bold; }

        .curl-box {
            font-family: monospace;
            font-size: 11px;
            background: #0a0a1a;
            padding: 12px;
            border-radius: 5px;
            word-break: break-all;
            white-space: pre-wrap;
            color: #888;
            border: 1px solid #0f3460;
        }

        .status-code { font-size: 16px; font-weight: bold; }
        .status-code.success { color: #27ae60; }
        .status-code.redirect { color: #f39c12; }
        .status-code.error { color: #e94560; }

        .detail-container { padding: 15px; }
        .section-title { color: #0f0; font-size: 12px; margin-bottom: 10px; text-transform: uppercase; }

        .method-OPTIONS { background: #16a085; }
        .method-HEAD { background: #8e44ad; }
        .method-TRACE { background: #95a5a6; }
        .method-CONNECT { background: #34495e; }

        .form-group { margin-bottom: 10px; }
        .form-label { display: block; color: #888; font-size: 11px; margin-bottom: 5px; text-transform: uppercase; }
        .form-row { display: flex; gap: 8px; align-items: center; }
        .form-row input, .form-row select { flex: 1; }

        .kv-editor { margin-top: 8px; }
        .kv-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .kv-row input { flex: 1; }
        .kv-row .kv-key { flex: 0.4; }
        .kv-row .kv-value { flex: 0.5; }
        .kv-row .btn { flex: 0.1; padding: 6px 8px; min-width: 32px; }

        .tab-container { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 1px solid #0f3460; }
        .tab-btn { background: none; border: none; color: #888; padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #0f0; border-bottom-color: #0f0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .collapsible-section { margin-bottom: 10px; }
        .collapsible-header { background: #0f3460; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }
        .collapsible-header:hover { background: #1a4d7d; }
        .collapsible-body { padding: 10px; border: 1px solid #0f3460; border-top: none; border-radius: 0 0 4px 4px; }
        .collapsible-body.collapsed { display: none; }

        .json-error { color: #e94560; font-size: 11px; margin-top: 5px; }
        .json-valid { color: #27ae60; font-size: 11px; margin-top: 5px; }

        .file-input-wrapper { position: relative; }
        .file-input-wrapper input[type="file"] { opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer; }
        .file-input-label { display: block; padding: 10px; background: #0f3460; border: 1px dashed #0f0; border-radius: 4px; text-align: center; cursor: pointer; }
        .file-input-label:hover { background: #1a4d7d; }

        .preset-item { padding: 8px; background: #0f3460; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .preset-item:hover { background: #1a4d7d; }
        .preset-name { flex: 1; cursor: pointer; }

        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; }
        .checkbox-wrapper input[type="checkbox"] { width: auto; }
        .checkbox-wrapper label { margin: 0; font-size: 12px; cursor: pointer; }

        input[type="number"] { width: 80px; }

        @media (max-width: 768px) {
            .header-row, .kv-row, .form-row { flex-wrap: wrap; }
            .header-row input, .kv-row input, .form-row input, .form-row select { flex: 1 1 100%; }
            .header-row .btn, .kv-row .btn { flex: 0 0 auto; }
        }
    </style>
</head>
<body>
    <h1>PCAPC</h1>
    <div class="container">
        <div id="screen-browse" class="screen">
            <div class="panel">
                <div class="panel-header"><span>Select Folder</span></div>
                <div class="path-display" id="current-path">~</div>
                <div class="panel-body" id="folder-list"><div class="status">Loading...</div></div>
            </div>
            <button class="btn" id="btn-select-folder" style="width:100%; margin-top:10px;">Select This Folder</button>
        </div>

        <div id="screen-scan" class="screen hidden">
            <div class="panel">
                <div class="panel-header">
                    <button class="back-btn" onclick="showScreen('browse')">‚Üê</button>
                    <span>Found PCAP Files</span>
                </div>
                <div class="panel-body" id="pairs-list"></div>
            </div>
            <button class="btn" id="btn-parse" style="width:100%; margin-top:10px;">Parse All</button>
        </div>

        <div id="screen-hosts" class="screen hidden">
            <div class="panel">
                <div class="panel-header">
                    <button class="back-btn" onclick="showScreen('scan')">‚Üê</button>
                    <span>Hosts</span>
                </div>
                <div class="stats" id="parse-stats"></div>
                <div class="panel-body" id="hosts-list"></div>
            </div>
        </div>

        <div id="screen-requests" class="screen hidden">
            <div class="panel">
                <div class="panel-header">
                    <button class="back-btn" onclick="showScreen('hosts')">‚Üê</button>
                    <span id="requests-host">Requests</span>
                </div>
                <div class="panel-body" id="requests-list"></div>
            </div>
        </div>

        <div id="screen-detail" class="screen hidden">
            <div class="panel">
                <div class="panel-header">
                    <button class="back-btn" onclick="showScreen('requests')">‚Üê</button>
                    <span>Request / Response</span>
                </div>
                <div class="detail-container" id="request-detail"></div>
            </div>
        </div>
    </div>

    <script>
        let currentPath = '';
        let currentHost = '';
        let currentRequests = [];
        let currentRequest = null;
        let editableRequest = {
            method: 'GET',
            url: '',
            headers: {},
            body: '',
            contentType: 'application/json',
            customContentType: '',
            queryParams: {},
            authType: 'none',
            authData: {},
            followRedirects: true,
            timeout: 30,
            userAgent: ''
        };
        let presets = {};

        function showScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-' + name).classList.remove('hidden');
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function formatBody(body) {
            if (!body) return '';
            try { return JSON.stringify(JSON.parse(body), null, 2); } catch { return body; }
        }

        async function browse(path) {
            const res = await fetch('/api/browse', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: path || '~'})
            });
            const data = await res.json();
            if (data.success) {
                currentPath = data.path;
                document.getElementById('current-path').textContent = data.path;
                const list = document.getElementById('folder-list');
                list.innerHTML = data.entries.length === 0 ? '<div class="status">Empty folder</div>' :
                    data.entries.map(e => `<div class="list-item" onclick="browse('${escapeHtml(e.path)}')"><span><span class="folder-icon">üìÅ</span>${escapeHtml(e.name)}</span></div>`).join('');
            }
        }

        async function scanFolder() {
            const btn = document.getElementById('btn-select-folder');
            btn.disabled = true; btn.textContent = 'Scanning...';
            const res = await fetch('/api/scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({folder: currentPath}) });
            const data = await res.json();
            btn.disabled = false; btn.textContent = 'Select This Folder';
            if (data.success) {
                document.getElementById('pairs-list').innerHTML = data.pairs.length === 0 ? '<div class="status">No PCAP files found</div>' :
                    data.pairs.map(p => `<div class="list-item"><div><div style="color:#0f0">${escapeHtml(p.pcap)}</div><div class="uri">‚Ü≥ ${escapeHtml(p.keylog)}</div></div></div>`).join('');
                showScreen('scan');
            }
        }

        async function parseAll() {
            const btn = document.getElementById('btn-parse');
            btn.disabled = true; btn.innerHTML = '<div class="loader" style="width:20px;height:20px;margin:0 auto;"></div>';
            const res = await fetch('/api/parse', {method: 'POST'});
            const data = await res.json();
            btn.disabled = false; btn.textContent = 'Parse All';
            if (data.success) {
                document.getElementById('parse-stats').innerHTML = `<div class="stat">Files: <span class="stat-value">${data.parsed}</span></div><div class="stat">Requests: <span class="stat-value">${data.unique_requests}</span></div><div class="stat">Hosts: <span class="stat-value">${data.hosts}</span></div>`;
                await loadHosts();
                showScreen('hosts');
            }
        }

        async function loadHosts() {
            const res = await fetch('/api/hosts');
            const data = await res.json();
            document.getElementById('hosts-list').innerHTML = data.hosts.map(h => `<div class="list-item" onclick="loadRequests('${escapeHtml(h.host)}')"><span>${escapeHtml(h.host)}</span><span>${h.has_auth ? '<span class="badge badge-auth">AUTH</span>' : ''}${h.has_cookie ? '<span class="badge badge-cookie">COOKIE</span>' : ''}<span class="badge badge-count">${h.count}</span></span></div>`).join('');
        }

        async function loadRequests(host) {
            currentHost = host;
            document.getElementById('requests-host').textContent = host;
            const res = await fetch('/api/requests/' + encodeURIComponent(host));
            const data = await res.json();
            currentRequests = data.requests;
            document.getElementById('requests-list').innerHTML = data.requests.map((r, i) => `<div class="list-item" onclick="showRequest(${i})"><div><span class="method method-${r.method}">${r.method}</span>${r.headers.Authorization ? '<span class="badge badge-auth">AUTH</span>' : ''}${r.headers.Cookie ? '<span class="badge badge-cookie">COOKIE</span>' : ''}<div class="uri">${escapeHtml(r.uri.substring(0, 60))}${r.uri.length > 60 ? '...' : ''}</div></div></div>`).join('');
            showScreen('requests');
        }

        function showRequest(index) {
            currentRequest = currentRequests[index];
            editableRequest = {
                method: currentRequest.method,
                url: currentRequest.full_url,
                headers: {...currentRequest.headers},
                body: currentRequest.body || '',
                contentType: currentRequest.headers['Content-Type'] || 'application/json',
                customContentType: '',
                queryParams: parseQueryParams(currentRequest.full_url),
                authType: 'none',
                authData: {},
                followRedirects: true,
                timeout: 30,
                userAgent: currentRequest.headers['User-Agent'] || ''
            };
            loadPresetsFromStorage();
            renderRequestDetail();
            showScreen('detail');
        }

        function parseQueryParams(url) {
            try {
                const urlObj = new URL(url);
                const params = {};
                urlObj.searchParams.forEach((value, key) => {
                    params[key] = value;
                });
                return params;
            } catch {
                return {};
            }
        }

        function buildUrlWithParams() {
            try {
                const urlObj = new URL(editableRequest.url.split('?')[0]);
                urlObj.search = '';
                Object.entries(editableRequest.queryParams).forEach(([k, v]) => {
                    if (k) urlObj.searchParams.append(k, v);
                });
                return urlObj.toString();
            } catch {
                return editableRequest.url;
            }
        }

        function renderRequestDetail() {
            const methods = ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS', 'TRACE', 'CONNECT'];
            const contentTypes = ['application/json', 'application/x-www-form-urlencoded', 'multipart/form-data', 'text/plain', 'text/xml', 'application/xml', 'custom'];
            const needsBody = ['POST', 'PUT', 'PATCH'].includes(editableRequest.method);

            // Query params HTML
            const qpEntries = Object.entries(editableRequest.queryParams);
            const qpHtml = qpEntries.map(([k, v]) => `<div class="kv-row"><input type="text" class="edit-input kv-key" value="${escapeHtml(k)}" onchange="updateQueryKey('${escapeHtml(k)}', this.value)" placeholder="Key"><input type="text" class="edit-input kv-value" value="${escapeHtml(v)}" onchange="updateQueryValue('${escapeHtml(k)}', this.value)" placeholder="Value"><button class="btn btn-small btn-danger" onclick="removeQueryParam('${escapeHtml(k)}')">√ó</button></div>`).join('');

            // Headers HTML
            const headerEntries = Object.entries(editableRequest.headers).filter(([k]) => !['Content-Type', 'Authorization'].includes(k));
            const headersHtml = headerEntries.map(([k, v]) => `<div class="kv-row"><input type="text" class="edit-input kv-key" value="${escapeHtml(k)}" onchange="updateHeaderKey('${escapeHtml(k)}', this.value)" placeholder="Header"><input type="text" class="edit-input kv-value" value="${escapeHtml(v)}" onchange="updateHeaderValue('${escapeHtml(k)}', this.value)" placeholder="Value"><button class="btn btn-small btn-danger" onclick="removeHeader('${escapeHtml(k)}')">√ó</button></div>`).join('');

            // Body editor based on content type
            let bodyEditorHtml = '';
            if (needsBody) {
                const ct = editableRequest.contentType === 'custom' ? editableRequest.customContentType : editableRequest.contentType;

                if (ct === 'application/json' || editableRequest.contentType === 'application/json') {
                    bodyEditorHtml = `
                        <textarea class="edit-textarea" id="edit-body" oninput="validateJson(this.value)" placeholder='{"key": "value"}'>${escapeHtml(editableRequest.body)}</textarea>
                        <div id="json-validation"></div>
                    `;
                } else if (ct === 'application/x-www-form-urlencoded' || editableRequest.contentType === 'application/x-www-form-urlencoded') {
                    const formData = parseFormData(editableRequest.body);
                    const formHtml = Object.entries(formData).map(([k, v]) => `<div class="kv-row"><input type="text" class="edit-input kv-key" value="${escapeHtml(k)}" onchange="updateFormKey('${escapeHtml(k)}', this.value)" placeholder="Key"><input type="text" class="edit-input kv-value" value="${escapeHtml(v)}" onchange="updateFormValue('${escapeHtml(k)}', this.value)" placeholder="Value"><button class="btn btn-small btn-danger" onclick="removeFormField('${escapeHtml(k)}')">√ó</button></div>`).join('');
                    bodyEditorHtml = `
                        <div class="kv-editor" id="form-editor">${formHtml || '<div style="color:#666;font-size:11px;">No fields</div>'}</div>
                        <button class="btn btn-small btn-secondary" onclick="addFormField()" style="margin-top:8px;">+ Add Field</button>
                    `;
                } else if (ct === 'multipart/form-data' || editableRequest.contentType === 'multipart/form-data') {
                    bodyEditorHtml = `
                        <div class="file-input-wrapper">
                            <input type="file" id="file-upload" multiple onchange="handleFileUpload(this.files)">
                            <div class="file-input-label">Click or drag files here</div>
                        </div>
                        <div id="multipart-fields" style="margin-top:10px;"></div>
                        <button class="btn btn-small btn-secondary" onclick="addMultipartField()" style="margin-top:8px;">+ Add Field</button>
                    `;
                } else {
                    bodyEditorHtml = `<textarea class="edit-textarea" id="edit-body" oninput="editableRequest.body = this.value; updateCurl();" placeholder="Raw body content">${escapeHtml(editableRequest.body)}</textarea>`;
                }
            }

            // Auth helper HTML
            let authHelperHtml = '';
            if (editableRequest.authType === 'basic') {
                authHelperHtml = `
                    <div class="form-row"><input type="text" class="edit-input" placeholder="Username" value="${escapeHtml(editableRequest.authData.username || '')}" onchange="editableRequest.authData.username = this.value; applyAuth();"></div>
                    <div class="form-row"><input type="password" class="edit-input" placeholder="Password" value="${escapeHtml(editableRequest.authData.password || '')}" onchange="editableRequest.authData.password = this.value; applyAuth();"></div>
                `;
            } else if (editableRequest.authType === 'bearer') {
                authHelperHtml = `<div class="form-row"><input type="text" class="edit-input" placeholder="Token" value="${escapeHtml(editableRequest.authData.token || '')}" onchange="editableRequest.authData.token = this.value; applyAuth();"></div>`;
            } else if (editableRequest.authType === 'apikey') {
                authHelperHtml = `
                    <div class="form-row">
                        <select class="edit-select" onchange="editableRequest.authData.location = this.value; applyAuth();">
                            <option value="header" ${editableRequest.authData.location === 'header' ? 'selected' : ''}>Header</option>
                            <option value="query" ${editableRequest.authData.location === 'query' ? 'selected' : ''}>Query Param</option>
                        </select>
                    </div>
                    <div class="form-row"><input type="text" class="edit-input" placeholder="Key name" value="${escapeHtml(editableRequest.authData.keyName || 'X-API-Key')}" onchange="editableRequest.authData.keyName = this.value; applyAuth();"></div>
                    <div class="form-row"><input type="text" class="edit-input" placeholder="Key value" value="${escapeHtml(editableRequest.authData.keyValue || '')}" onchange="editableRequest.authData.keyValue = this.value; applyAuth();"></div>
                `;
            }

            // Presets HTML
            const hostPresets = presets[currentHost] || [];
            const presetsHtml = hostPresets.map((p, i) => `<div class="preset-item"><span class="preset-name" onclick="loadPreset(${i})">${escapeHtml(p.name)}</span><button class="btn btn-small btn-danger" onclick="deletePreset(${i})">√ó</button></div>`).join('');

            document.getElementById('request-detail').innerHTML = `
                <div class="payload-box">
                    <div class="payload-header request">
                        <span>REQUEST</span>
                        <select class="edit-select" id="method-select" onchange="editableRequest.method = this.value; renderRequestDetail();">${methods.map(m => `<option value="${m}" ${editableRequest.method === m ? 'selected' : ''}>${m}</option>`).join('')}</select>
                    </div>

                    <div class="tab-container">
                        <button class="tab-btn active" onclick="switchTab('tab-url')">URL & Params</button>
                        <button class="tab-btn" onclick="switchTab('tab-auth')">Auth</button>
                        <button class="tab-btn" onclick="switchTab('tab-headers')">Headers</button>
                        ${needsBody ? '<button class="tab-btn" onclick="switchTab(\'tab-body\')">Body</button>' : ''}
                        <button class="tab-btn" onclick="switchTab('tab-options')">Options</button>
                        <button class="tab-btn" onclick="switchTab('tab-presets')">Presets</button>
                    </div>

                    <div id="tab-url" class="tab-content active">
                        <div class="form-group">
                            <label class="form-label">Base URL</label>
                            <input type="text" class="edit-input" id="edit-url" value="${escapeHtml(editableRequest.url.split('?')[0])}" onchange="editableRequest.url = this.value; editableRequest.queryParams = {}; renderRequestDetail();">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Query Parameters <button class="btn btn-small btn-secondary" onclick="addQueryParam()" style="float:right;">+ Add</button></label>
                            <div class="kv-editor">${qpHtml || '<div style="color:#666;font-size:11px;">No query parameters</div>'}</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Full URL</label>
                            <div class="curl-box" style="font-size:11px;">${escapeHtml(buildUrlWithParams())}</div>
                        </div>
                    </div>

                    <div id="tab-auth" class="tab-content">
                        <div class="form-group">
                            <label class="form-label">Authentication Type</label>
                            <select class="edit-select" style="width:100%;" onchange="editableRequest.authType = this.value; renderRequestDetail();">
                                <option value="none" ${editableRequest.authType === 'none' ? 'selected' : ''}>None</option>
                                <option value="basic" ${editableRequest.authType === 'basic' ? 'selected' : ''}>Basic Auth</option>
                                <option value="bearer" ${editableRequest.authType === 'bearer' ? 'selected' : ''}>Bearer Token</option>
                                <option value="apikey" ${editableRequest.authType === 'apikey' ? 'selected' : ''}>API Key</option>
                            </select>
                        </div>
                        ${authHelperHtml}
                    </div>

                    <div id="tab-headers" class="tab-content">
                        <div class="form-group">
                            <label class="form-label">Custom Headers <button class="btn btn-small btn-secondary" onclick="addHeader()" style="float:right;">+ Add</button></label>
                            <div class="kv-editor">${headersHtml || '<div style="color:#666;font-size:11px;">No custom headers</div>'}</div>
                        </div>
                    </div>

                    ${needsBody ? `
                    <div id="tab-body" class="tab-content">
                        <div class="form-group">
                            <label class="form-label">Content-Type</label>
                            <select class="edit-select" style="width:100%;" onchange="editableRequest.contentType = this.value; renderRequestDetail();">
                                ${contentTypes.map(ct => `<option value="${ct}" ${editableRequest.contentType === ct ? 'selected' : ''}>${ct === 'custom' ? 'Custom' : ct}</option>`).join('')}
                            </select>
                        </div>
                        ${editableRequest.contentType === 'custom' ? `<div class="form-group"><input type="text" class="edit-input" placeholder="Custom Content-Type" value="${escapeHtml(editableRequest.customContentType)}" onchange="editableRequest.customContentType = this.value; updateCurl();"></div>` : ''}
                        <div class="form-group">
                            <label class="form-label">Body</label>
                            ${bodyEditorHtml}
                        </div>
                    </div>` : ''}

                    <div id="tab-options" class="tab-content">
                        <div class="form-group">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="follow-redirects" ${editableRequest.followRedirects ? 'checked' : ''} onchange="editableRequest.followRedirects = this.checked; updateCurl();">
                                <label for="follow-redirects">Follow Redirects</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Timeout (seconds)</label>
                            <input type="number" class="edit-input" value="${editableRequest.timeout}" min="1" max="300" onchange="editableRequest.timeout = parseInt(this.value); updateCurl();">
                        </div>
                        <div class="form-group">
                            <label class="form-label">User-Agent</label>
                            <input type="text" class="edit-input" placeholder="Custom User-Agent" value="${escapeHtml(editableRequest.userAgent)}" onchange="editableRequest.userAgent = this.value; updateCurl();">
                        </div>
                    </div>

                    <div id="tab-presets" class="tab-content">
                        <div class="form-group">
                            <label class="form-label">Save Current Request</label>
                            <div class="form-row">
                                <input type="text" class="edit-input" id="preset-name" placeholder="Preset name">
                                <button class="btn btn-secondary" onclick="savePreset()">Save</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Saved Presets for ${escapeHtml(currentHost)}</label>
                            <div>${presetsHtml || '<div style="color:#666;font-size:11px;">No presets saved</div>'}</div>
                        </div>
                    </div>
                </div>

                <div class="section-title">cURL Command</div>
                <div class="curl-box" id="curl-preview">Loading...</div>

                <div class="actions">
                    <button class="btn btn-execute" onclick="executeRequest()">Execute Request</button>
                    <button class="btn btn-secondary" onclick="copyToClipboard()">Copy cURL</button>
                    <button class="btn btn-secondary" onclick="resetRequest()">Reset</button>
                </div>

                <div class="payload-box" id="response-box">
                    <div class="payload-header response waiting" id="response-header"><span>RESPONSE</span><span id="response-status">Waiting...</span></div>
                    <div class="payload-section"><div class="payload-section-title">Headers</div><div class="payload-content" id="response-headers">(execute request to see response)</div></div>
                    <div class="payload-section"><div class="payload-section-title">Body</div><div class="payload-content" id="response-body">(execute request to see response)</div></div>
                </div>
            `;
            updateCurl();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Header management
        function updateHeaderKey(oldKey, newKey) {
            if (oldKey !== newKey) {
                const value = editableRequest.headers[oldKey];
                delete editableRequest.headers[oldKey];
                editableRequest.headers[newKey] = value;
                renderRequestDetail();
            }
        }
        function updateHeaderValue(key, value) { editableRequest.headers[key] = value; updateCurl(); }
        function addHeader() {
            let key = 'X-Custom-Header', i = 1;
            while (editableRequest.headers[key]) key = 'X-Custom-Header-' + i++;
            editableRequest.headers[key] = '';
            renderRequestDetail();
        }
        function removeHeader(key) { delete editableRequest.headers[key]; renderRequestDetail(); }

        // Query params management
        function updateQueryKey(oldKey, newKey) {
            if (oldKey !== newKey) {
                const value = editableRequest.queryParams[oldKey];
                delete editableRequest.queryParams[oldKey];
                editableRequest.queryParams[newKey] = value;
                renderRequestDetail();
            }
        }
        function updateQueryValue(key, value) { editableRequest.queryParams[key] = value; renderRequestDetail(); }
        function addQueryParam() {
            let key = 'param', i = 1;
            while (editableRequest.queryParams[key]) key = 'param' + i++;
            editableRequest.queryParams[key] = '';
            renderRequestDetail();
        }
        function removeQueryParam(key) { delete editableRequest.queryParams[key]; renderRequestDetail(); }

        // Form data management
        function parseFormData(body) {
            if (!body) return {};
            const params = {};
            body.split('&').forEach(pair => {
                const [key, value] = pair.split('=');
                if (key) params[decodeURIComponent(key)] = decodeURIComponent(value || '');
            });
            return params;
        }
        function serializeFormData(data) {
            return Object.entries(data).map(([k, v]) => encodeURIComponent(k) + '=' + encodeURIComponent(v)).join('&');
        }
        function updateFormKey(oldKey, newKey) {
            const formData = parseFormData(editableRequest.body);
            if (oldKey !== newKey) {
                const value = formData[oldKey];
                delete formData[oldKey];
                formData[newKey] = value;
            }
            editableRequest.body = serializeFormData(formData);
            renderRequestDetail();
        }
        function updateFormValue(key, value) {
            const formData = parseFormData(editableRequest.body);
            formData[key] = value;
            editableRequest.body = serializeFormData(formData);
            updateCurl();
        }
        function addFormField() {
            const formData = parseFormData(editableRequest.body);
            let key = 'field', i = 1;
            while (formData[key]) key = 'field' + i++;
            formData[key] = '';
            editableRequest.body = serializeFormData(formData);
            renderRequestDetail();
        }
        function removeFormField(key) {
            const formData = parseFormData(editableRequest.body);
            delete formData[key];
            editableRequest.body = serializeFormData(formData);
            renderRequestDetail();
        }

        // Multipart data
        function handleFileUpload(files) {
            // For now, just show file names - actual upload would need backend support
            const fieldDiv = document.getElementById('multipart-fields');
            Array.from(files).forEach(file => {
                const div = document.createElement('div');
                div.style.cssText = 'padding:8px;background:#0f3460;margin-bottom:5px;border-radius:4px;';
                div.textContent = `File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                fieldDiv.appendChild(div);
            });
        }
        function addMultipartField() {
            alert('Multipart field editor - add key-value pairs for form fields (file upload requires backend support)');
        }

        // JSON validation
        function validateJson(text) {
            editableRequest.body = text;
            const validationDiv = document.getElementById('json-validation');
            if (!text.trim()) {
                validationDiv.innerHTML = '';
                updateCurl();
                return;
            }
            try {
                JSON.parse(text);
                validationDiv.innerHTML = '<div class="json-valid">Valid JSON</div>';
            } catch (e) {
                validationDiv.innerHTML = `<div class="json-error">Invalid JSON: ${escapeHtml(e.message)}</div>`;
            }
            updateCurl();
        }

        // Auth helpers
        function applyAuth() {
            delete editableRequest.headers['Authorization'];
            if (editableRequest.authType === 'basic') {
                const {username, password} = editableRequest.authData;
                if (username || password) {
                    const encoded = btoa(`${username || ''}:${password || ''}`);
                    editableRequest.headers['Authorization'] = `Basic ${encoded}`;
                }
            } else if (editableRequest.authType === 'bearer') {
                const {token} = editableRequest.authData;
                if (token) {
                    editableRequest.headers['Authorization'] = `Bearer ${token}`;
                }
            } else if (editableRequest.authType === 'apikey') {
                const {location, keyName, keyValue} = editableRequest.authData;
                if (keyName && keyValue) {
                    if (location === 'header') {
                        editableRequest.headers[keyName] = keyValue;
                    } else if (location === 'query') {
                        editableRequest.queryParams[keyName] = keyValue;
                    }
                }
            }
            updateCurl();
        }

        // Presets management
        function loadPresetsFromStorage() {
            try {
                const stored = localStorage.getItem('pcapc-presets');
                if (stored) presets = JSON.parse(stored);
            } catch (e) {
                console.error('Failed to load presets:', e);
            }
        }
        function savePresetsToStorage() {
            try {
                localStorage.setItem('pcapc-presets', JSON.stringify(presets));
            } catch (e) {
                console.error('Failed to save presets:', e);
            }
        }
        function savePreset() {
            const nameInput = document.getElementById('preset-name');
            const name = nameInput.value.trim();
            if (!name) {
                alert('Please enter a preset name');
                return;
            }
            if (!presets[currentHost]) presets[currentHost] = [];
            presets[currentHost].push({
                name: name,
                data: JSON.parse(JSON.stringify(editableRequest))
            });
            savePresetsToStorage();
            nameInput.value = '';
            renderRequestDetail();
        }
        function loadPreset(index) {
            const hostPresets = presets[currentHost];
            if (hostPresets && hostPresets[index]) {
                editableRequest = JSON.parse(JSON.stringify(hostPresets[index].data));
                renderRequestDetail();
            }
        }
        function deletePreset(index) {
            if (confirm('Delete this preset?')) {
                presets[currentHost].splice(index, 1);
                if (presets[currentHost].length === 0) delete presets[currentHost];
                savePresetsToStorage();
                renderRequestDetail();
            }
        }

        function resetRequest() {
            editableRequest = {
                method: currentRequest.method,
                url: currentRequest.full_url,
                headers: {...currentRequest.headers},
                body: currentRequest.body || '',
                contentType: currentRequest.headers['Content-Type'] || 'application/json',
                customContentType: '',
                queryParams: parseQueryParams(currentRequest.full_url),
                authType: 'none',
                authData: {},
                followRedirects: true,
                timeout: 30,
                userAgent: currentRequest.headers['User-Agent'] || ''
            };
            renderRequestDetail();
        }

        async function updateCurl() {
            // Build final headers with Content-Type and User-Agent
            const finalHeaders = {...editableRequest.headers};

            if (['POST', 'PUT', 'PATCH'].includes(editableRequest.method)) {
                const ct = editableRequest.contentType === 'custom' ? editableRequest.customContentType : editableRequest.contentType;
                if (ct) finalHeaders['Content-Type'] = ct;
            }

            if (editableRequest.userAgent) {
                finalHeaders['User-Agent'] = editableRequest.userAgent;
            }

            const finalUrl = buildUrlWithParams();

            const res = await fetch('/api/curl', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    method: editableRequest.method,
                    full_url: finalUrl,
                    headers: finalHeaders,
                    body: editableRequest.body
                })
            });
            const data = await res.json();
            document.getElementById('curl-preview').textContent = data.curl;
        }

        async function executeRequest() {
            const rh = document.getElementById('response-header');
            const rs = document.getElementById('response-status');
            const rhdrs = document.getElementById('response-headers');
            const rb = document.getElementById('response-body');

            rh.className = 'payload-header response waiting';
            rs.textContent = 'Loading...';
            rhdrs.textContent = 'Loading...';
            rb.textContent = 'Loading...';

            try {
                // Build final headers
                const finalHeaders = {...editableRequest.headers};

                if (['POST', 'PUT', 'PATCH'].includes(editableRequest.method)) {
                    const ct = editableRequest.contentType === 'custom' ? editableRequest.customContentType : editableRequest.contentType;
                    if (ct) finalHeaders['Content-Type'] = ct;
                }

                if (editableRequest.userAgent) {
                    finalHeaders['User-Agent'] = editableRequest.userAgent;
                }

                const finalUrl = buildUrlWithParams();

                const res = await fetch('/api/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        method: editableRequest.method,
                        url: finalUrl,
                        headers: finalHeaders,
                        body: editableRequest.body,
                        timeout: editableRequest.timeout,
                        follow_redirects: editableRequest.followRedirects
                    })
                });

                const data = await res.json();

                if (data.success) {
                    const code = parseInt(data.status_code) || 0;
                    let sc = code >= 200 && code < 300 ? 'success' : code >= 300 && code < 400 ? 'redirect' : 'error';
                    rh.className = 'payload-header response' + (code >= 400 ? ' error' : '');
                    rs.innerHTML = `<span class="status-code ${sc}">HTTP ${data.status_code}</span>`;

                    const hdrs = Object.entries(data.headers || {});
                    rhdrs.innerHTML = hdrs.length > 0 ? hdrs.map(([k, v]) => `<div>${escapeHtml(k)}: ${escapeHtml(v)}</div>`).join('') : '(no headers)';
                    rb.textContent = data.body ? formatBody(data.body) : '(empty body)';
                } else {
                    rh.className = 'payload-header response error';
                    rs.textContent = 'ERROR';
                    rhdrs.textContent = '';
                    rb.textContent = data.error || 'Unknown error';
                }
            } catch (e) {
                rh.className = 'payload-header response error';
                rs.textContent = 'ERROR';
                rhdrs.textContent = '';
                rb.textContent = e.message;
            }
        }

        function copyToClipboard() {
            const curl = document.getElementById('curl-preview').textContent;
            navigator.clipboard.writeText(curl).then(() => alert('Copied!')).catch(() => { const ta = document.createElement('textarea'); ta.value = curl; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('Copied!'); });
        }

        document.getElementById('btn-select-folder').onclick = scanFolder;
        document.getElementById('btn-parse').onclick = parseAll;
        browse('~');
    </script>
</body>
</html>
